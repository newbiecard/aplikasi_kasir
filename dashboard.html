<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“Š Dashboard - Nasi Daun Jeruk POS</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dashboard-page">
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="dashboard-logo">
                <span class="logo-icon">ðŸ“Š</span>
                <div>
                    <h1>Dashboard Real-Time</h1>
                    <p class="subtitle">Nasi Daun Jeruk POS - Analytics</p>
                </div>
            </div>
            <div class="dashboard-actions">
                <button class="btn-refresh" onclick="loadDashboardData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn-export" onclick="exportData()">
                    <i class="fas fa-download"></i> Export
                </button>
                <button class="btn-back" onclick="window.history.back()">
                    <i class="fas fa-arrow-left"></i> Kembali
                </button>
            </div>
        </header>

        <!-- Stats Overview -->
        <section class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="totalTransactions">0</div>
                    <div class="stat-label">Total Transaksi</div>
                </div>
            </div>
            
            <div class="stat-card success">
                <div class="stat-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="totalRevenue">Rp 0</div>
                    <div class="stat-label">Total Pendapatan</div>
                </div>
            </div>
            
            <div class="stat-card warning">
                <div class="stat-icon">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="todayTransactions">0</div>
                    <div class="stat-label">Hari Ini</div>
                </div>
            </div>
            
            <div class="stat-card info">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="avgTransaction">Rp 0</div>
                    <div class="stat-label">Rata-rata</div>
                </div>
            </div>
        </section>

        <!-- Charts -->
        <section class="charts-section">
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-line"></i> Pendapatan Harian</h3>
                    <select id="chartRange" onchange="updateChart()">
                        <option value="7">7 Hari</option>
                        <option value="30" selected>30 Hari</option>
                        <option value="90">90 Hari</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-pie"></i> Popularitas Menu</h3>
                </div>
                <div class="chart-container">
                    <canvas id="menuChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Recent Transactions -->
        <section class="transactions-section">
            <div class="section-header">
                <h2><i class="fas fa-history"></i> Transaksi Terbaru</h2>
                <input type="text" class="search-input" placeholder="Cari transaksi..." id="searchTransaction">
            </div>
            <div class="transactions-table">
                <table>
                    <thead>
                        <tr>
                            <th>Waktu</th>
                            <th>ID Transaksi</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsList">
                        <tr>
                            <td colspan="5" class="loading">Memuat data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="table-footer">
                <div class="pagination">
                    <button class="btn-prev" onclick="prevPage()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="pageInfo">Halaman 1</span>
                    <button class="btn-next" onclick="nextPage()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="summary">
                    Menampilkan <span id="showingCount">0</span> dari <span id="totalCount">0</span> transaksi
                </div>
            </div>
        </section>

        <!-- Sync Status -->
        <section class="sync-section">
            <div class="sync-card">
                <h3><i class="fas fa-sync-alt"></i> Status Sinkronisasi</h3>
                <div class="sync-info">
                    <div class="sync-item">
                        <span>Terakhir Sync:</span>
                        <span id="lastSyncTime">-</span>
                    </div>
                    <div class="sync-item">
                        <span>Pending Sync:</span>
                        <span id="pendingSyncCount">0</span>
                    </div>
                    <div class="sync-item">
                        <span>Status:</span>
                        <span class="status-badge online" id="syncStatusBadge">Online</span>
                    </div>
                </div>
                <button class="btn-sync-now" onclick="forceSync()">
                    <i class="fas fa-bolt"></i> Sync Sekarang
                </button>
            </div>
            
            <div class="export-card">
                <h3><i class="fas fa-database"></i> Backup Data</h3>
                <p>Ekspor data transaksi untuk backup atau analisis</p>
                <div class="export-actions">
                    <button class="btn-export-csv" onclick="exportCSV()">
                        <i class="fas fa-file-csv"></i> CSV
                    </button>
                    <button class="btn-export-json" onclick="exportJSON()">
                        <i class="fas fa-file-code"></i> JSON
                    </button>
                    <button class="btn-clear-data" onclick="clearData()">
                        <i class="fas fa-trash"></i> Hapus Data
                    </button>
                </div>
            </div>
        </section>
    </div>

    <script src="config.js"></script>
    <script>
        // Dashboard JavaScript
        let currentPage = 1;
        const pageSize = 10;
        let allTransactions = [];
        let revenueChart = null;
        let menuChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
            updateClock();
            setInterval(updateClock, 1000);
        });

        function loadDashboardData() {
            loadStats();
            loadRecentTransactions();
            loadCharts();
            updateSyncStatus();
        }

        function loadStats() {
            try {
                const history = JSON.parse(localStorage.getItem('zeta_transaction_history') || '[]');
                const syncQueue = JSON.parse(localStorage.getItem('zeta_sync_queue') || '[]');
                
                // Calculate stats
                const totalTransactions = history.length;
                const totalRevenue = history.reduce((sum, t) => sum + (t.total || 0), 0);
                
                // Today's transactions
                const today = new Date().toLocaleDateString('id-ID');
                const todayTransactions = history.filter(t => t.date === today).length;
                
                // Average transaction
                const avgTransaction = totalTransactions > 0 ? totalRevenue / totalTransactions : 0;
                
                // Update UI
                document.getElementById('totalTransactions').textContent = totalTransactions;
                document.getElementById('totalRevenue').textContent = formatRupiah(totalRevenue);
                document.getElementById('todayTransactions').textContent = todayTransactions;
                document.getElementById('avgTransaction').textContent = formatRupiah(avgTransaction);
                document.getElementById('pendingSyncCount').textContent = syncQueue.length;
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function loadRecentTransactions() {
            try {
                const history = JSON.parse(localStorage.getItem('zeta_transaction_history') || '[]');
                allTransactions = history.reverse();
                
                // Apply search filter
                const searchTerm = document.getElementById('searchTransaction').value.toLowerCase();
                let filteredTransactions = allTransactions;
                
                if (searchTerm) {
                    filteredTransactions = allTransactions.filter(t => 
                        t.transaction_id.toLowerCase().includes(searchTerm) ||
                        t.items.some(item => item.name.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Calculate pagination
                const totalPages = Math.ceil(filteredTransactions.length / pageSize);
                const startIndex = (currentPage - 1) * pageSize;
                const endIndex = startIndex + pageSize;
                const pageTransactions = filteredTransactions.slice(startIndex, endIndex);
                
                // Update table
                const tbody = document.getElementById('transactionsList');
                
                if (pageTransactions.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="no-data">
                                <i class="fas fa-inbox"></i>
                                <p>Tidak ada data transaksi</p>
                            </td>
                        </tr>
                    `;
                } else {
                    let html = '';
                    pageTransactions.forEach(transaction => {
                        const itemsText = transaction.items.map(i => `${i.name} (${i.quantity}x)`).join(', ');
                        
                        html += `
                            <tr>
                                <td>${transaction.time}</td>
                                <td><code>${transaction.transaction_id}</code></td>
                                <td>${itemsText.substring(0, 50)}${itemsText.length > 50 ? '...' : ''}</td>
                                <td class="amount">${formatRupiah(transaction.total)}</td>
                                <td>
                                    <span class="status-badge ${transaction.status === 'completed' ? 'success' : 'warning'}">
                                        ${transaction.status}
                                    </span>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tbody.innerHTML = html;
                }
                
                // Update pagination info
                document.getElementById('pageInfo').textContent = `Halaman ${currentPage} dari ${totalPages}`;
                document.getElementById('showingCount').textContent = pageTransactions.length;
                document.getElementById('totalCount').textContent = filteredTransactions.length;
                
            } catch (error) {
                console.error('Error loading transactions:', error);
                document.getElementById('transactionsList').innerHTML = `
                    <tr>
                        <td colspan="5" class="error">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Gagal memuat data</p>
                        </td>
                    </tr>
                `;
            }
        }

        function loadCharts() {
            // Load data for charts
            const history = JSON.parse(localStorage.getItem('zeta_transaction_history') || '[]');
            
            // Prepare data for revenue chart (last 30 days)
            const days = 30;
            const revenueByDate = {};
            const today = new Date();
            
            // Initialize last 30 days
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('id-ID');
                revenueByDate[dateStr] = 0;
            }
            
            // Fill with actual data
            history.forEach(transaction => {
                if (revenueByDate.hasOwnProperty(transaction.date)) {
                    revenueByDate[transaction.date] += transaction.total || 0;
                }
            });
            
            // Create revenue chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: Object.keys(revenueByDate),
                    datasets: [{
                        label: 'Pendapatan',
                        data: Object.values(revenueByDate),
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => 'Rp ' + value.toLocaleString('id-ID')
                            }
                        }
                    }
                }
            });
            
            // Prepare data for menu chart
            const menuCounts = {};
            history.forEach(transaction => {
                transaction.items.forEach(item => {
                    menuCounts[item.name] = (menuCounts[item.name] || 0) + item.quantity;
                });
            });
            
            // Sort by count and take top 5
            const popularMenus = Object.entries(menuCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            // Create menu chart
            const menuCtx = document.getElementById('menuChart').getContext('2d');
            
            if (menuChart) {
                menuChart.destroy();
            }
            
            menuChart = new Chart(menuCtx, {
                type: 'doughnut',
                data: {
                    labels: popularMenus.map(m => m[0]),
                    datasets: [{
                        data: popularMenus.map(m => m[1]),
                        backgroundColor: [
                            '#10B981', '#3B82F6', '#8B5CF6', '#F59E0B', '#EF4444'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function updateChart() {
            loadCharts();
        }

        function updateSyncStatus() {
            const lastSync = localStorage.getItem('zeta_last_sync');
            document.getElementById('lastSyncTime').textContent = 
                lastSync ? new Date(lastSync).toLocaleTimeString('id-ID') : '-';
            
            const isOnline = navigator.onLine;
            const badge = document.getElementById('syncStatusBadge');
            badge.textContent = isOnline ? 'Online' : 'Offline';
            badge.className = `status-badge ${isOnline ? 'online' : 'offline'}`;
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('lastSyncTime').textContent = now.toLocaleTimeString('id-ID');
        }

        function forceSync() {
            if (window.backgroundSync) {
                window.backgroundSync.syncPendingTransactions();
                showNotification('Sinkronisasi dimulai...', 'info');
            }
        }

        function exportCSV() {
            const history = JSON.parse(localStorage.getItem('zeta_transaction_history') || '[]');
            
            // Create CSV content
            let csv = 'ID,Date,Time,Items,Total,Cash,Change,Status\n';
            
            history.forEach(t => {
                const items = t.items.map(i => `${i.name} (${i.quantity}x)`).join('; ');
                csv += `"${t.transaction_id}","${t.date}","${t.time}","${items}",${t.total},${t.cash_received},${t.change},${t.status}\n`;
            });
            
            // Download CSV
            downloadFile(csv, 'transactions.csv', 'text/csv');
            showNotification('Data diekspor sebagai CSV', 'success');
        }

        function exportJSON() {
            const history = JSON.parse(localStorage.getItem('zeta_transaction_history') || '[]');
            const data = {
                exported_at: new Date().toISOString(),
                total_transactions: history.length,
                transactions: history
            };
            
            const json = JSON.stringify(data, null, 2);
            downloadFile(json, 'transactions.json', 'application/json');
            showNotification('Data diekspor sebagai JSON', 'success');
        }

        function clearData() {
            if (confirm('HAPUS SEMUA DATA?\n\nIni tidak dapat dibatalkan!\n\nTransaksi akan hilang permanen.')) {
                localStorage.removeItem('zeta_transaction_history');
                localStorage.removeItem('zeta_sync_queue');
                showNotification('Semua data dihapus', 'warning');
                loadDashboardData();
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadRecentTransactions();
            }
        }

        function nextPage() {
            const totalItems = allTransactions.length;
            const totalPages = Math.ceil(totalItems / pageSize);
            
            if (currentPage < totalPages) {
                currentPage++;
                loadRecentTransactions();
            }
        }

        function exportData() {
            // Export all data
            const data = {
                transactions: JSON.parse(localStorage.getItem('zeta_transaction_history') || '[]'),
                sync_queue: JSON.parse(localStorage.getItem('zeta_sync_queue') || '[]'),
                config: JSON.parse(localStorage.getItem('zeta_pos_config_v2') || '{}'),
                exported_at: new Date().toISOString()
            };
            
            const json = JSON.stringify(data, null, 2);
            downloadFile(json, `zeta_pos_backup_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
            showNotification('Backup data berhasil', 'success');
        }

        // Utility functions
        function formatRupiah(amount) {
            return 'Rp ' + amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showNotification(message, type) {
            // Simple notification implementation
            alert(`${type.toUpperCase()}: ${message}`);
        }

        // Search functionality
        document.getElementById('searchTransaction').addEventListener('input', () => {
            currentPage = 1;
            loadRecentTransactions();
        });
    </script>
</body>
</html>
